_schema-version: '1.0'
repository: scai-dev.common.repositories.cloud.sap
# Tag will be dynamically set from package.json name field
tag: "$(jq -r '.name' package.json)"
before-all:
  - export TARGETPLATFORM=linux/amd64
  - npx cds build --production
  - cp -r app/router gen/chart/router
  - VERSION=$(jq -r '.name' package.json)

after-all:
  - echo "Build complete, updating tag in chart/values.yaml $VERSION | $(jq -r '.name' package.json)"
  - yq -i '.global.image.tag = $(jq -r '.name' package.json)' chart/values.yaml

modules:
  - name: router/api
    build-parameters:
      commands:
        - docker buildx build --platform linux/amd64 -t router/api:$(jq -r '.name' package.json) -f Dockerfile . --load

  - name: agents/mastra
    build-parameters:
      commands:
        - docker buildx build --platform linux/amd64 -t agents/mastra:$(jq -r '.name' package.json) -f app/mastra/Dockerfile --target dev . --load

  - name: router/approuter
    build-parameters:
      commands:
        - cp -r app/router gen/chart/router
        - docker pull sapse/approuter:20.7.0
        - docker tag sapse/approuter:20.7.0 router/approuter:$(jq -r '.name' package.json)
  - name: v1-approuter
    build-parameters:
      buildpack:
        type: nodejs
        builder: builder-jammy-base
        path: app/router
        env:
          BP_NODE_RUN_SCRIPTS: ""

#      buildpack:
#        type: nodejs
#        builder: builder-jammy-base
#        path: app/router
#        env:
#          BP_NODE_RUN_SCRIPTS: ""
